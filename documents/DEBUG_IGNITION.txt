===============================================
DEBUG DE IGNIÃ‡ÃƒO - CorreÃ§Ãµes Aplicadas
===============================================

## ğŸ› Problema Identificado

**Sintoma:** "Pulso fica perdido, Ã s vezes sÃ³ muda de fase"

**Causa:** Dwell angle maior que disponÃ­vel antes do spark angle

## ğŸ“Š Exemplo do Bug (Antes da CorreÃ§Ã£o)

### A 6000 RPM com advance=15Â° e dwell=3ms:

```
revolutionTime = 10.000Âµs (10ms por revoluÃ§Ã£o)
dwellTime = 3.000Âµs (3ms fixo)
dwellAngle = (3000 Ã— 360) / 10000 = 108Â°  â† MUITO GRANDE!

advance = 15Â° BTDC
sparkAngle = 360 - 15 = 345Â°

dwellStartAngle = 345 - 108 = 237Â°  â† VÃ¡lido, mas muito cedo
```

### A 8000 RPM (pior caso):

```
revolutionTime = 7.500Âµs
dwellAngle = (3000 Ã— 360) / 7500 = 144Â°  â† MAIOR QUE 180Â°!

sparkAngle = 345Â°
dwellStartAngle = 345 - 144 = 201Â°  â† Ainda vÃ¡lido mas...

Se advance < 10Â°:
sparkAngle = 350Â°
dwellStartAngle = 350 - 144 = 206Â°
```

### Quando advance=5Â° (idle):

```
sparkAngle = 360 - 5 = 355Â°
dwellStartAngle = 355 - 144 = 211Â°

Mas se dwellAngle > sparkAngle:
dwellStartAngle = 0  â† PROBLEMA!
```

---

## âœ… CorreÃ§Ãµes Aplicadas

### 1. Limitar Dwell Angle a 180Â° MÃ¡ximo

```cpp
// decoders.cpp linha 87-92
if (dwellAngle > 180) {
  dwellAngle = 180;
  dwellTime = (180UL * triggerState.revolutionTime) / 360UL;
}
```

**Resultado:**
- A 8000 RPM: dwell limitado a 3.75ms (180Â° Ã— 7500Âµs / 360Â°)
- Ainda suficiente para carga completa da bobina

### 2. ProteÃ§Ã£o Quando Dwell > Spark Angle

```cpp
// decoders.cpp linha 100-109
if (sparkAngle > dwellAngle) {
  dwellStartAngle = sparkAngle - dwellAngle;
} else {
  // Ajusta dwell para caber
  dwellStartAngle = 0;
  dwellAngle = sparkAngle;
  dwellTime = (dwellAngle * triggerState.revolutionTime) / 360UL;
}
```

**Resultado:**
- Se nÃ£o couber, ajusta dwell para comeÃ§ar em 0Â° e terminar no spark angle

### 3. ValidaÃ§Ã£o de Timing MÃ­nimo

```cpp
// scheduler.cpp linha 134-137
if (startTicks < 50) {  // Menos de 25Âµs
  schedule->status = SCHED_OFF;
  return;
}
```

**Resultado:**
- NÃ£o agenda igniÃ§Ã£o se timing Ã© impossÃ­vel
- Evita "pulso perdido" ou "sÃ³ muda de fase"

---

## ğŸ§ª Teste de ValidaÃ§Ã£o

### Valores Esperados A 1000 RPM:

```
revolutionTime = 60.000Âµs
dwellTime = 3.000Âµs
dwellAngle = 18Â°  â† OK!

advance = 15Â° BTDC
sparkAngle = 345Â°
dwellStartAngle = 327Â°

timeToDwell = (327 Ã— 60000) / 360 = 54.500Âµs = 54.5ms
```

**VisualizaÃ§Ã£o:**
```
0Â°                    327Â°         345Â°    360Â°
|---------------------|------------|------|
    54.5ms                3ms dwell   spark
    Gap aqui                    Bobina carga â†‘
                                           FaÃ­sca! âš¡
```

### Valores Esperados A 6000 RPM:

```
revolutionTime = 10.000Âµs
dwellTime = 3.000Âµs
dwellAngle = 108Â°  â† Maior que 180Â°? NÃƒO mais!

ApÃ³s proteÃ§Ã£o:
dwellAngle = 108Â°  (ainda menor que 180Â°, OK)

sparkAngle = 345Â°
dwellStartAngle = 345 - 108 = 237Â°

timeToDwell = (237 Ã— 10000) / 360 = 6.583Âµs
```

**VÃ¡lido!** Bobina tem 3ms para carregar antes da faÃ­sca.

---

## ğŸ“Š Checklist de ValidaÃ§Ã£o no Simulador

ApÃ³s recompilar:

- [ ] IgniÃ§Ã£o 1 pulsa a cada 2 revoluÃ§Ãµes (junto com Bico 1)
- [ ] IgniÃ§Ã£o 2 pulsa a cada 2 revoluÃ§Ãµes (junto com Bico 2)
- [ ] **NÃƒO** hÃ¡ "pulso perdido" (igniÃ§Ã£o sempre tem pulso visÃ­vel)
- [ ] **NÃƒO** hÃ¡ "sÃ³ muda de fase" (sempre HIGH â†’ LOW â†’ HIGH)
- [ ] Pulso de igniÃ§Ã£o Ã© **CURTO** (~3ms @ 1000 RPM)
- [ ] Pulso ocorre **LOGO ANTES** do prÃ³ximo gap (near TDC)

### PadrÃ£o Visual Esperado:

```
Gap    Bico1  Ign1   Gap    Bico2  Ign2   Gap
 â†“      ___     _      â†“      ___     _     â†“
 |_____|   |___|_|_____|_____|   |___|_|____|
 0Â°    270Â° 345Â° 360Â°  0Â°    270Â° 345Â° 360Â°
      inj  dwell       inj  dwell
```

---

## ğŸ”¬ Debug Adicional (Se Problema Persistir)

Adicione no final de `scheduleIgnitionISR()` (linha 112):

```cpp
#ifdef DEBUG_ENABLED
  Serial.print(F("Ign"));
  Serial.print((revolutionCounter == 0) ? 1 : 2);
  Serial.print(F(" dA:"));
  Serial.print(dwellAngle);
  Serial.print(F(" sA:"));
  Serial.print(sparkAngle);
  Serial.print(F(" dsA:"));
  Serial.print(dwellStartAngle);
  Serial.print(F(" ttd:"));
  Serial.println(timeToDwell);
#endif
```

**SaÃ­da esperada @ 1000 RPM:**
```
Ign1 dA:18 sA:345 dsA:327 ttd:54500
Ign2 dA:18 sA:345 dsA:327 ttd:54500
```

**Se dA > 180 aparecer:** ProteÃ§Ã£o nÃ£o estÃ¡ funcionando
**Se dsA = 0 aparecer:** Spark angle muito pequeno
**Se ttd < 100 aparecer:** Timing invÃ¡lido (deve ser rejeitado)

---

## âœ… Resultado Esperado

ApÃ³s essas correÃ§Ãµes:
- âœ… IgniÃ§Ã£o sempre tem pulso completo
- âœ… Dwell limitado a valores seguros
- âœ… Timing sempre vÃ¡lido ou rejeitado
- âœ… Sem "mudanÃ§a de fase" sem pulso

===============================================
